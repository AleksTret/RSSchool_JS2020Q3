const en = {
    1 : {
        normal : "1",
        caps : "1",
        shift : "!"
    },
    2 : {
        normal : "2",
        caps : "2",
        shift : "@"
    },
    3 : {
        normal : "3",
        caps : "3",
        shift : "#"
    },
    4 : {
        normal : "4",
        caps : "4",
        shift : "$"
    },
    5 : {
        normal : "5",
        caps : "5",
        shift : "%"
    },
    6 : {
        normal : "6",
        caps : "6",
        shift : "^"
    },
    7 : {
        normal : "7",
        caps : "7",
        shift : "&"
    },
    8 : {
        normal : "8",
        caps : "8",
        shift : "*"
    },
    9 : {
        normal : "9",
        caps : "9",
        shift : "("
    },
    10 : {
        normal : "0",
        caps : "0",
        shift : ")"
    },
    11 : {
        normal : "-",
        caps : "-",
        shift : "_"
    },
    12 : {
        normal : "=",
        caps : "=",
        shift : "+"
    },
    13 : {
        normal : "backspace",
        caps : "backspace",
        shift : "backspace"
    },
    14 : {
        normal : "q",
        caps : "Q",
        shift : "Q"
    },
    15 : {
        normal : "w",
        caps : "W",
        shift : "W"
    },
    16 : {
        normal : "e",
        caps : "E",
        shift : "E"
    },
    17 : {
        normal : "r",
        caps : "R",
        shift : "R"
    },
    18 : {
        normal : "t",
        caps : "T",
        shift : "T"
    },
    19 : {
        normal : "y",
        caps : "Y",
        shift : "Y"
    },
    20 : {
        normal : "u",
        caps : "U",
        shift : "U"
    },
    21 : {
        normal : "i",
        caps : "I",
        shift : "I"
    },
    22 : {
        normal : "o",
        caps : "O",
        shift : "O"
    },
    23 : {
        normal : "p",
        caps : "P",
        shift : "P"
    },
    24 : {
        normal : "[",
        caps : "[",
        shift : "{"
    },
    25 : {
        normal : "]",
        caps : "]",
        shift : "}"
    },
    26 : {
        normal : "capslock",
        caps : "capslock",
        shift : "casplock"
    },
    27 : {
        normal : "a",
        caps : "A",
        shift : "A"
    },
    28 : {
        normal : "s",
        caps : "S",
        shift : "S"
    },
    29 : {
        normal : "d",
        caps : "D",
        shift : "D"
    },
    30 : {
        normal : "f",
        caps : "F",
        shift : "F"
    },
    31 : {
        normal : "g",
        caps : "G",
        shift : "G"
    },
    32 : {
        normal : "h",
        caps : "H",
        shift : "H"
    },
    33 : {
        normal : "j",
        caps : "J",
        shift : "J"
    },
    34 : {
        normal : "k",
        caps : "K",
        shift : "K"
    },
    35 : {
        normal : "l",
        caps : "L",
        shift : "L"
    },
    36 : {
        normal : ";",
        caps : ";",
        shift : ":"
    },
    37 : {
        normal : "'",
        caps : "'",
        shift : "\""
    },
    38 : {
        normal : "enter",
        caps : "enter",
        shift : "enter"
    },
    39 : {
        normal : "language",
        caps : "language",
        shift : "language"
    },
    40 : {
        normal : "shift",
        caps : "shift",
        shift : "shift"
    },
    41 : {
        normal : "z",
        caps : "Z",
        shift : "Z"
    },
    42 : {
        normal : "x",
        caps : "X",
        shift : "X"
    },
    43 : {
        normal : "c",
        caps : "C",
        shift : "C"
    },
    44 : {
        normal : "v",
        caps : "V",
        shift : "V"
    },
    45 : {
        normal : "b",
        caps : "B",
        shift : "B"
    },
    46 : {
        normal : "n",
        caps : "N",
        shift : "N"
    },
    47 : {
        normal : "m",
        caps : "M",
        shift : "M"
    },
    48 : {
        normal : ",",
        caps : ",",
        shift : "<"
    },
    49 : {
        normal : ".",
        caps : ".",
        shift : ">"
    },
    50 : {
        normal : "/",
        caps : "/",
        shift : "?"
    },
    51 : {
        normal : "done",
        caps : "done",
        shift : "done"
    },
    52 : {
        normal : "space",
        caps : "space",
        shift : "space"
    },
    53 :{
        normal : "left_arrow",
        caps : "left_arrow",
        shift : "left_arrow"
    },
    54 : {
        normal : "right_arrow",
        caps : "right_arrow",
        shift : "right_arrow"
    }
}

const ru = {
    1 : {
        normal : "1",
        caps : "1",
        shift : "!"
    },
    2 : {
        normal : "2",
        caps : "2",
        shift : "\""
    },
    3 : {
        normal : "3",
        caps : "3",
        shift : "№"
    },
    4 : {
        normal : "4",
        caps : "4",
        shift : ";"
    },
    5 : {
        normal : "5",
        caps : "5",
        shift : "%"
    },
    6 : {
        normal : "6",
        caps : "6",
        shift : ":"
    },
    7 : {
        normal : "7",
        caps : "7",
        shift : "?"
    },
    8 : {
        normal : "8",
        caps : "8",
        shift : "*"
    },
    9 : {
        normal : "9",
        caps : "9",
        shift : "("
    },
    10 : {
        normal : "0",
        caps : "0",
        shift : ")"
    },
    11 : {
        normal : "-",
        caps : "-",
        shift : "_"
    },
    12 : {
        normal : "=",
        caps : "=",
        shift : "+"
    },
    13 : {
        normal : "backspace",
        caps : "backspace",
        shift : "backspace"
    },
    14 : {
        normal : "й",
        caps : "Й",
        shift : "Й"
    },
    15 : {
        normal : "ц",
        caps : "Ц",
        shift : "Ц"
    },
    16 : {
        normal : "у",
        caps : "У",
        shift : "У"
    },
    17 : {
        normal : "к",
        caps : "К",
        shift : "К"
    },
    18 : {
        normal : "е",
        caps : "Е",
        shift : "Е"
    },
    19 : {
        normal : "н",
        caps : "Н",
        shift : "Н"
    },
    20 : {
        normal : "г",
        caps : "Г",
        shift : "Г"
    },
    21 : {
        normal : "ш",
        caps : "Ш",
        shift : "Ш"
    },
    22 : {
        normal : "щ",
        caps : "Щ",
        shift : "Щ"
    },
    23 : {
        normal : "з",
        caps : "З",
        shift : "З"
    },
    24 : {
        normal : "х",
        caps : "Х",
        shift : "Х"
    },
    25 : {
        normal : "ъ",
        caps : "Ъ",
        shift : "Ъ"
    },
    26 : {
        normal : "capslock",
        caps : "capslock",
        shift : "casplock"
    },
    27 : {
        normal : "ф",
        caps : "Ф",
        shift : "Ф"
    },
    28 : {
        normal : "ы",
        caps : "Ы",
        shift : "Ы"
    },
    29 : {
        normal : "в",
        caps : "В",
        shift : "В"
    },
    30 : {
        normal : "а",
        caps : "А",
        shift : "А"
    },
    31 : {
        normal : "п",
        caps : "П",
        shift : "П"
    },
    32 : {
        normal : "р",
        caps : "Р",
        shift : "Р"
    },
    33 : {
        normal : "о",
        caps : "О",
        shift : "О"
    },
    34 : {
        normal : "л",
        caps : "Л",
        shift : "Л"
    },
    35 : {
        normal : "д",
        caps : "Д",
        shift : "Д"
    },
    36 : {
        normal : "ж",
        caps : "Ж",
        shift : "Ж"
    },
    37 : {
        normal : "э",
        caps : "Э",
        shift : "Э"
    },
    38 : {
        normal : "enter",
        caps : "enter",
        shift : "enter"
    },
    39 : {
        normal : "language",
        caps : "language",
        shift : "language"
    },
    40 : {
        normal : "shift",
        caps : "shift",
        shift : "shift"
    },
    41 : {
        normal : "я",
        caps : "Я",
        shift : "Я"
    },
    42 : {
        normal : "ч",
        caps : "Ч",
        shift : "Ч"
    },
    43 : {
        normal : "с",
        caps : "С",
        shift : "С"
    },
    44 : {
        normal : "м",
        caps : "М",
        shift : "М"
    },
    45 : {
        normal : "и",
        caps : "И",
        shift : "И"
    },
    46 : {
        normal : "т",
        caps : "Т",
        shift : "Т"
    },
    47 : {
        normal : "ь",
        caps : "Ь",
        shift : "Ь"
    },
    48 : {
        normal : "б",
        caps : "Б",
        shift : "Б"
    },
    49 : {
        normal : "ю",
        caps : "Ю",
        shift : "Ю"
    },
    50 : {
        normal : ".",
        caps : ".",
        shift : ","
    },
    51 : {
        normal : "done",
        caps : "done",
        shift : "done"
    },
    52 : {
        normal : "space",
        caps : "space",
        shift : "space"
    },
    53 :{
        normal : "left_arrow",
        caps : "left_arrow",
        shift : "left_arrow"
    },
    54 : {
        normal : "right_arrow",
        caps : "right_arrow",
        shift : "right_arrow"
    }
}

const Keyboard = {
    textArea : document.querySelector(".use-keyboard-input"),

    elements: {
        main: null,
        keysContainer: null,
        keys: []
    },

    properties: {
        capsLock: false,
        shift: false,
        language: ""
    },

    init() {
        this.languages = ["en", "ru"],
        this.properties.language = this.languages[0]
        this.keyLayouts = new Map();
        this.keyLayouts.set("en", new Map(Object.entries(en)));
        this.keyLayouts.set("ru", new Map(Object.entries(ru)));
        
        this.currentLayout = this.keyLayouts.get(this.properties.language);

        this.elements.main = document.createElement("div");
        this.elements.keysContainer = document.createElement("div");

        this.elements.main.classList.add("keyboard", "keyboard--hidden");
        this.elements.keysContainer.classList.add("keyboard__keys");

        this.elements.keysContainer.appendChild(this._createKeys());

        this.elements.keys = this.elements.keysContainer.querySelectorAll(".keyboard__key");

        this.elements.main.appendChild(this.elements.keysContainer);
        document.body.appendChild(this.elements.main);

        document.querySelectorAll(".use-keyboard-input").forEach(element => {
            element.addEventListener("focus", () => {
                this._showKeyboard();
            });    
        })
    },

    _createIconHTML(icon_name){
        return `<i class="material-icons">${icon_name}</i>`;
    },

    _createKeys(){
        const fragment = document.createDocumentFragment();

        this.currentLayout.forEach((value, key, map) => {
            const keyElement = document.createElement("button");

            const insertLineBreak = ["13", "25", "38", "50"].indexOf(key) !== -1;

            keyElement.setAttribute("type", "button");
            keyElement.setAttribute("data", key);
            keyElement.classList.add("keyboard__key");
            
            switch (value.normal) {
                case "backspace":
                    keyElement.classList.add("keyboard__key--wide");
                    keyElement.innerHTML = this._createIconHTML("backspace");

                    keyElement.addEventListener("click", () => this._delete(this.textArea));

                    break;

                case "capslock":
                    keyElement.classList.add("keyboard__key--wide", "keyboard__key--activatable");
                    keyElement.innerHTML = this._createIconHTML("keyboard_capslock");

                    keyElement.addEventListener("click", () => {
                        this._toggleCapsLock();
                        keyElement.classList.toggle("keyboard__key--active", this.properties.capsLock);
                        this.textArea.focus();
                    });
                    break;

                case "enter":
                    keyElement.classList.add("keyboard__key--wide");
                    keyElement.innerHTML = this._createIconHTML("keyboard_return");

                    keyElement.addEventListener("click", (event) => this._print(event, this.textArea, "\n"));

                    break;

                case "space":
                    keyElement.classList.add("keyboard__key--extra-wide");
                    keyElement.innerHTML = this._createIconHTML("space_bar");

                    keyElement.addEventListener("click", (event) => this._print(event, this.textArea, " "));

                    break;

                case "done":
                    keyElement.classList.add("keyboard__key--wide", "keyboard__key--dark");
                    keyElement.innerHTML = this._createIconHTML("check_circle");

                    keyElement.addEventListener("click", () => this._hideKeyboard());
                    break;

                case "shift":
                    keyElement.classList.add("keyboard__key--activatable", "keyboard__key--wide");
                    keyElement.innerHTML = this._createIconHTML("arrow_circle_up");
                    keyElement.addEventListener("click", () => {
                        this._toggleShift();
                        keyElement.classList.toggle("keyboard__key--active", this.properties.shift);
                        this.textArea.focus();
                    });
                    break;
                
                case "language":
                    keyElement.classList.add("keyboard__key--wide");
                    keyElement.innerHTML = this._createIconHTML("language") + `<span class="language_name">${this.properties.language}</span>`;
                    keyElement.addEventListener("click", () => {
                        this._toggleLang();
                        this.textArea.focus();
                    })
                    break;

                case "left_arrow":
                    keyElement.innerHTML = this._createIconHTML("keyboard_arrow_left");
                    keyElement.addEventListener("click", () => {
                        this.textArea.focus();
                        if (this.textArea.selectionStart)
                        { 
                            let currentPositionCursor = this.textArea.selectionStart;
                            this.textArea.setSelectionRange(currentPositionCursor - 1,currentPositionCursor - 1);
                        }
                        this.textArea.focus();
                    })
                    break;

                case "right_arrow":
                    keyElement.innerHTML = this._createIconHTML("keyboard_arrow_right");
                    keyElement.addEventListener("click", () => {
                        this.textArea.focus();
                        let currentPositionCursor = this.textArea.selectionStart;
                        this.textArea.setSelectionRange(currentPositionCursor + 1,currentPositionCursor + 1);
                        this.textArea.focus();
                    })
                    break;
        
                default:
                    keyElement.innerHTML = value.normal;

                    keyElement.addEventListener("click", (event) => this._print(event, this.textArea));

                    break;
            }

            fragment.appendChild(keyElement);

            if (insertLineBreak){
                fragment.appendChild(document.createElement("br"));
            }
        });

        return fragment;
    },

    _print(event, textArea, symbol){
        const startPosition = textArea.selectionStart;
        const endPosition = textArea.selectionEnd;
        
        let text = textArea.value.substring(0, startPosition) + (symbol || event.currentTarget.innerText) + textArea.value.substring(endPosition);

        textArea.value = text;

        textArea.focus();

        textArea.selectionEnd = (startPosition == endPosition) ? (startPosition + 1) : endPosition - 1;
    },

    _delete(textArea){
        const startPosition = textArea.selectionStart;
        const endPosition = textArea.selectionEnd;
     
        textArea.value = (startPosition == endPosition) ?
                            textArea.value.substring(0, startPosition - 1) + textArea.value.substring(endPosition):
                            textArea.value.substring(0, startPosition) + textArea.value.substring(endPosition);
        textArea.focus();

        textArea.selectionEnd = (startPosition == endPosition) ? startPosition - 1 : startPosition;
    },

    _toggleCapsLock(){
        this.properties.capsLock = !this.properties.capsLock;  

        this.elements.keys.forEach(key => {
            if(key.childElementCount !== 0) return;
            const dataAttribute = key.getAttribute("data");
            const letterObject = this.currentLayout.get(dataAttribute);
            key.innerHTML = this._getSymbol(this.properties.capsLock, this.properties.shift, letterObject);
        });
    },

    _getSymbol(caps, shift, letterObject){
        const isSpecialSymbol = letterObject.normal === letterObject.caps;
        if (caps){
            return !shift ? letterObject.caps : 
                            isSpecialSymbol ? letterObject.shift : letterObject.normal;
        }
        else {
            return shift ? letterObject.shift : letterObject.normal;
        }
    },

    _toggleShift(){
        this.properties.shift = !this.properties.shift;

        this.elements.keys.forEach(key => {
            if(key.childElementCount !== 0) return;
            const dataAttribute = key.getAttribute("data");
            const letterObject = this.currentLayout.get(dataAttribute);        
            key.innerHTML = this._getSymbol(this.properties.capsLock, this.properties.shift, letterObject);     
        });
    },

    _toggleLang(){
        const index = this.languages.indexOf(this.properties.language);
        const next = index < this.languages.length - 1 ? index + 1 : 0;
        this.properties.language = this.languages[next];
        
        this.currentLayout = this.keyLayouts.get(this.properties.language);

        this.elements.keys.forEach(key => {


            if(key.childElementCount !== 0) {
                let span = key.getElementsByClassName("language_name");
                if (span.length){
                    key.innerHTML = this._createIconHTML("language") + `<span class="language_name">${this.properties.language}</span>`;
                }                
                return;
            }
            const dataAttribute = key.getAttribute("data");
            const letterObject = this.properties.language ? this.currentLayout.get(dataAttribute) : this.currentLayout.get(dataAttribute);       

            key.innerHTML = this._getSymbol(this.properties.capsLock, this.properties.shift, letterObject);
        })
    },

    _showKeyboard(){
        this.elements.main.classList.remove("keyboard--hidden");
    },

    _hideKeyboard(){
        this.elements.main.classList.add("keyboard--hidden");
    }
}

window.addEventListener("DOMContentLoaded", () => Keyboard.init());